<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
 <title>Sports Tracker - Admin Interface</title>
 <link rel="stylesheet" href="draft1.css">
 <script type="module">
     import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
     import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
     import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
     import { getFirestore, collection, doc, setDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";




     // Your web app's Firebase configuration (iacs project)
     const firebaseConfig = {
         apiKey: "AIzaSyBpkEnq2Kjotqm9Ukk2Cklj6ACZjWq1dEY",
         authDomain: "iacs-95ea7.firebaseapp.com",
         databaseURL: "https://iacs-95ea7-default-rtdb.asia-southeast1.firebasedatabase.app",
         projectId: "iacs-95ea7",
         storageBucket: "iacs-95ea7.firebasestorage.app",
         messagingSenderId: "413625128566",
         appId: "1:413625128566:web:b7499fd9a6e58d42203157",
         measurementId: "G-2ZKQ8M550N"
     };




     // Initialize Firebase
     const app = initializeApp(firebaseConfig);
     const analytics = getAnalytics(app);
     console.log('Firebase initialized successfully');
     console.log('Database URL:', firebaseConfig.databaseURL);








     const realtimeDB = getDatabase(app);
     const realtimeGameRef = ref(realtimeDB, 'currentGame');
     console.log('Realtime Database reference created for path: /currentGame');
     console.log('Full database path: https://iacs-95ea7-default-rtdb.asia-southeast1.firebasedatabase.app/currentGame');








     const db = getFirestore(app);
     const gameRef = doc(db, 'games', 'currentGame');








     let isLocalRealtimeSync = false;








     function subscribeToRealtimeGame() {
         console.log('Connecting to Firebase Realtime Database...');
         console.log('Database URL: https://iacs-95ea7-default-rtdb.asia-southeast1.firebasedatabase.app/');
         console.log('Listening to path: /currentGame');
       
         const connectedRef = ref(realtimeDB, '.info/connected');
         onValue(connectedRef, (snapshot) => {
             if (snapshot.val() === true) {
                 console.log('✓ Connected to Firebase Realtime Database');
             } else {
                 console.log('✗ Disconnected from Firebase Realtime Database');
             }
         });
       
         onValue(realtimeGameRef, (snapshot) => {
             console.log('Received update from Firebase Realtime Database');
           
             if (!snapshot.exists()) {
                 console.log('No game data found in database (this is normal for a new game)');
                 return;
             }
           
             if (isLocalRealtimeSync) {
                 console.log('Ignoring local sync update');
                 return;
             }


             const remoteState = snapshot.val();
             if (!remoteState) {
                 console.log('Remote state is empty');
                 return;
             }


             console.log('Updating game state from database:', remoteState);
            
             // Deep copy the remote state to ensure all properties are synced
             gameState = JSON.parse(JSON.stringify(remoteState));


             // Ensure nested objects exist with default values if missing
             if (!gameState.teams) {
                 gameState.teams = {
                     team1: { id: '', score: 0, setsWon: 0 },
                     team2: { id: '', score: 0, setsWon: 0 }
                 };
             }
             if (!gameState.stats) {
                 gameState.stats = {
                     team1: { serves: 0, aces: 0, blocks: 0, spikes: 0 },
                     team2: { serves: 0, aces: 0, blocks: 0, spikes: 0 }
                 };
             }
             if (!gameState.players) {
                 gameState.players = { team1: {}, team2: {} };
             }
             if (!gameState.setHistory) {
                 gameState.setHistory = [];
             }
             if (gameState.isActive === undefined) {
                 gameState.isActive = false;
             }
             if (!gameState.sport) {
                 gameState.sport = 'volleyball';
             }
             if (!gameState.setNumber) {
                 gameState.setNumber = 1;
             }
             if (!gameState.maxSets) {
                 gameState.maxSets = 3;
             }


             // Update UI visibility based on game state
             const gamePanel = document.getElementById('game-panel');
             if (gameState.isActive) {
                 if (gamePanel) gamePanel.classList.remove('hidden');
                 // Recreate scoring buttons to ensure they're up to date
                 setTimeout(() => {
                     createScoringButtons();
                     populatePlayerSelects();
                 }, 50);
             } else {
                 if (gamePanel) gamePanel.classList.add('hidden');
             }


             // Update all UI elements
             updateGameDisplay();
            
             console.log('✓ UI updated with latest game state from database');
         }, (error) => {
             console.error('Error connecting to Firebase Realtime Database:', error);
             console.error('Error details:', error.message);
             alert('Error connecting to database. Please check your connection and try again.');
         });
     }








     let gameState = {
         isActive: false,
         sport: 'volleyball',
         teams: {
             team1: { id: '', score: 0, setsWon: 0 },
             team2: { id: '', score: 0, setsWon: 0 }
         },
         setNumber: 1,
         maxSets: 3,
         stats: {
             team1: {},
             team2: {}
         },
         players: {
             team1: {},
             team2: {}
         },
         setHistory: [] // Stores completed set data
     };








     function syncToFirebase() {
         // Ensure all required properties exist before syncing
         const stateToSync = {
             isActive: gameState.isActive || false,
             sport: gameState.sport || 'volleyball',
             teams: {
                 team1: {
                     id: gameState.teams?.team1?.id || '',
                     score: gameState.teams?.team1?.score || 0,
                     setsWon: gameState.teams?.team1?.setsWon || 0
                 },
                 team2: {
                     id: gameState.teams?.team2?.id || '',
                     score: gameState.teams?.team2?.score || 0,
                     setsWon: gameState.teams?.team2?.setsWon || 0
                 }
             },
             setNumber: gameState.setNumber || 1,
             maxSets: gameState.maxSets || 3,
             stats: {
                 team1: gameState.stats?.team1 || { serves: 0, aces: 0, blocks: 0, spikes: 0 },
                 team2: gameState.stats?.team2 || { serves: 0, aces: 0, blocks: 0, spikes: 0 }
             },
             players: {
                 team1: gameState.players?.team1 || {},
                 team2: gameState.players?.team2 || {}
             },
             setHistory: gameState.setHistory || [],
             playerNames: gameState.playerNames || { team1: [], team2: [] }
         };


         isLocalRealtimeSync = true;
        
         // Sync to Firebase Realtime Database (primary for live sync)
         set(realtimeGameRef, stateToSync)
         .then(() => {
             console.log('✓ Synced to Firebase Realtime Database at /currentGame');
             console.log('Synced state:', stateToSync);
            
             // Also sync to Firestore for backup/history (async, don't wait)
             setDoc(gameRef, stateToSync).catch(err => {
                 console.warn('Firestore sync warning:', err);
             });
         })
         .catch(error => {
             console.error('✗ Firebase Realtime Database sync error:', error);
             alert('Error syncing to database. Changes may not be saved.');
         })
         .finally(() => {
             // Reset flag after a short delay to ensure the listener processes the update
             setTimeout(() => {
                 isLocalRealtimeSync = false;
             }, 100);
         });
     }








     function startGame() {
         const team1Identifier = document.getElementById('team1-identifier').value;
         const team2Identifier = document.getElementById('team2-identifier').value;








         if (!team1Identifier || !team2Identifier) {
             alert('Please select both teams to start the match.');
             return;
         }








         if (team1Identifier === team2Identifier) {
             alert('Teams cannot be the same. Please select two different teams.');
             return;
         }








         gameState.teams.team1 = { id: team1Identifier, score: 0, setsWon: 0 };
         gameState.teams.team2 = { id: team2Identifier, score: 0, setsWon: 0 };
         gameState.sport = 'volleyball';
         gameState.isActive = true;
         gameState.setNumber = 1;
         gameState.maxSets = 3;
         gameState.setHistory = []; // Reset set history for new game




         // Store player names for later use
         const t1PlayersRaw = document.getElementById('team1-players').value || '';
         const t2PlayersRaw = document.getElementById('team2-players').value || '';
         gameState.playerNames = {
             team1: t1PlayersRaw.split(',').map(p => p.trim()).filter(Boolean),
             team2: t2PlayersRaw.split(',').map(p => p.trim()).filter(Boolean)
         };
       
         gameState.players.team1 = {};
         gameState.players.team2 = {};
         gameState.playerNames.team1.forEach(name => {
             gameState.players.team1[name] = { serves: 0, aces: 0, blocks: 0, spikes: 0, points: 0 };
         });
         gameState.playerNames.team2.forEach(name => {
             gameState.players.team2[name] = { serves: 0, aces: 0, blocks: 0, spikes: 0, points: 0 };
         });








         initializeStats();
         updateGameDisplay();
         createScoringButtons();
         document.getElementById('game-panel').classList.remove('hidden');
         populatePlayerSelects();
         syncToFirebase();
     }








     function initializeStats() {
         gameState.stats.team1 = { serves: 0, aces: 0, blocks: 0, spikes: 0 };
         gameState.stats.team2 = { serves: 0, aces: 0, blocks: 0, spikes: 0 };
     }








     function updateGameDisplay() {
         // Ensure teams object exists
         if (!gameState.teams) {
             gameState.teams = {
                 team1: { id: '', score: 0, setsWon: 0 },
                 team2: { id: '', score: 0, setsWon: 0 }
             };
         }


         const team1Label = gameState.teams.team1?.id || '';
         const team2Label = gameState.teams.team2?.id || '';
         const team1Score = gameState.teams.team1?.score || 0;
         const team2Score = gameState.teams.team2?.score || 0;
         const team1SetsWon = gameState.teams.team1?.setsWon || 0;
         const team2SetsWon = gameState.teams.team2?.setsWon || 0;
         const setNumber = gameState.setNumber || 1;


         // Update all display elements
         const displayTeam1 = document.getElementById('display-team1');
         const displayTeam2 = document.getElementById('display-team2');
         const score1 = document.getElementById('score1');
         const score2 = document.getElementById('score2');
         const team1ControlTitle = document.getElementById('team1-control-title');
         const team2ControlTitle = document.getElementById('team2-control-title');
         const periodDisplay = document.getElementById('period-display');


         if (displayTeam1) displayTeam1.textContent = team1Label;
         if (displayTeam2) displayTeam2.textContent = team2Label;
         if (score1) score1.textContent = team1Score;
         if (score2) score2.textContent = team2Score;
         if (team1ControlTitle) team1ControlTitle.textContent = team1Label;
         if (team2ControlTitle) team2ControlTitle.textContent = team2Label;
         if (periodDisplay) {
             periodDisplay.textContent = `Set ${setNumber} | Sets: ${team1SetsWon} - ${team2SetsWon}`;
         }


         // Update stats and player selects
         updateStatsDisplay();
         populatePlayerSelects();
     }








     function createScoringButtons() {
         const team1Buttons = document.getElementById('team1-buttons');
         const team2Buttons = document.getElementById('team2-buttons');








         team1Buttons.innerHTML = '';
         team2Buttons.innerHTML = '';








         function createScoreButton(text, team, points, isPlus = true) {
             const button = document.createElement('button');
             button.textContent = text;
             button.className = `score-btn ${isPlus ? 'score-btn-plus' : 'score-btn-minus'}`;
             button.onclick = () => {
                 const selectedPlayer = getSelectedPlayer(team);
                 addScore(team, points, selectedPlayer);
             };
             return button;
         }








         function createStatButtonGroup(label, team, statType) {
             const container = document.createElement('div');
             container.style.display = 'flex';
             container.style.alignItems = 'center';
             container.style.gap = '5px';
             container.style.marginBottom = '5px';
           
             const labelSpan = document.createElement('span');
             labelSpan.textContent = label + ':';
             labelSpan.style.fontWeight = 'bold';
             labelSpan.style.minWidth = '100px';
             labelSpan.setAttribute('name', statType);
           
             const minusBtn = document.createElement('button');
             minusBtn.textContent = '-';
             minusBtn.className = 'score-btn score-btn-minus';
             minusBtn.style.padding = '5px 10px';
             minusBtn.onclick = () => {
                 const p = getSelectedPlayer(team);
                 if (p) addPlayerStat(team, p, statType, -1);
             };
           
             const plusBtn = document.createElement('button');
             plusBtn.textContent = '+';
             plusBtn.className = 'score-btn score-btn-plus';
             plusBtn.style.padding = '5px 10px';
             plusBtn.onclick = () => {
                 const p = getSelectedPlayer(team);
                 if (p) addPlayerStat(team, p, statType, 1);
             };
           
             container.appendChild(labelSpan);
             container.appendChild(minusBtn);
             container.appendChild(plusBtn);
           
             return container;
         }








         const getSelectedPlayer = (team) => {
             const select = document.getElementById(`${team}-player-select`);
             return select && select.value ? select.value : null;
         };








         team1Buttons.appendChild(createScoreButton('+1 Pt', 'team1', 1));
         team1Buttons.appendChild(createScoreButton('-1 Pt', 'team1', -1, false));
         team1Buttons.appendChild(createStatButtonGroup('Serve', 'team1', 'serve'));
         team1Buttons.appendChild(createStatButtonGroup('Service Ace', 'team1', 'ace'));
         team1Buttons.appendChild(createStatButtonGroup('Block', 'team1', 'block'));
         team1Buttons.appendChild(createStatButtonGroup('Spike', 'team1', 'spike'));








         team2Buttons.appendChild(createScoreButton('+1 Pt', 'team2', 1));
         team2Buttons.appendChild(createScoreButton('-1 Pt', 'team2', -1, false));
         team2Buttons.appendChild(createStatButtonGroup('Serve', 'team2', 'serve'));
         team2Buttons.appendChild(createStatButtonGroup('Service Ace', 'team2', 'ace'));
         team2Buttons.appendChild(createStatButtonGroup('Block', 'team2', 'block'));
         team2Buttons.appendChild(createStatButtonGroup('Spike', 'team2', 'spike'));
     }








     function addScore(team, points, playerName = null) {
         if (points < 0 && gameState.teams[team].score + points < 0) {
             gameState.teams[team].score = 0;
         } else {
             gameState.teams[team].score += points;
          
             // Sync player points for both positive and negative point changes
             if (playerName && gameState.players[team] && gameState.players[team][playerName]) {
                 const currentPoints = gameState.players[team][playerName].points || 0;
                 const newPoints = currentPoints + points;
                 // Ensure player points don't go below 0
                 gameState.players[team][playerName].points = Math.max(0, newPoints);
             }
         }
         updateGameDisplay();
         syncToFirebase();
     }








     function addPlayerStat(team, playerName, stat, increment = 1) {
         if (!gameState.players[team] || !gameState.players[team][playerName]) return;
         const p = gameState.players[team][playerName];
       
         if (stat === 'serve') {
             p.serves = (p.serves || 0) + increment;
             if (p.serves < 0) p.serves = 0;
             gameState.stats[team].serves = (gameState.stats[team].serves || 0) + increment;
             if (gameState.stats[team].serves < 0) gameState.stats[team].serves = 0;
         } else if (stat === 'ace') {
             p.aces = (p.aces || 0) + increment;
             if (p.aces < 0) p.aces = 0;
             gameState.stats[team].aces = (gameState.stats[team].aces || 0) + increment;
             if (gameState.stats[team].aces < 0) gameState.stats[team].aces = 0;
           
             // Connect serve count - when ace is incremented/decremented, also update serve
             p.serves = (p.serves || 0) + increment;
             if (p.serves < 0) p.serves = 0;
             gameState.stats[team].serves = (gameState.stats[team].serves || 0) + increment;
             if (gameState.stats[team].serves < 0) gameState.stats[team].serves = 0;
           
             // Only add score when incrementing ace (not decrementing)
             if (increment > 0) {
                 addScore(team, increment, playerName);
             } else if (increment < 0) {
                 // When decrementing ace, also decrement score
                 addScore(team, increment, playerName);
             }
         } else if (stat === 'block') {
             p.blocks = (p.blocks || 0) + increment;
             if (p.blocks < 0) p.blocks = 0;
             gameState.stats[team].blocks = (gameState.stats[team].blocks || 0) + increment;
             if (gameState.stats[team].blocks < 0) gameState.stats[team].blocks = 0;
           
             // Add/remove score when block is incremented/decremented
             addScore(team, increment, playerName);
         } else if (stat === 'spike') {
             p.spikes = (p.spikes || 0) + increment;
             if (p.spikes < 0) p.spikes = 0;
             gameState.stats[team].spikes = (gameState.stats[team].spikes || 0) + increment;
             if (gameState.stats[team].spikes < 0) gameState.stats[team].spikes = 0;
           
             // Add/remove score when spike is incremented/decremented
             addScore(team, increment, playerName);
         }
         updateStatsDisplay();
         syncToFirebase();
     }








     function populatePlayerSelects() {
         const t1Select = document.getElementById('team1-player-select');
         const t2Select = document.getElementById('team2-player-select');
         if (t1Select) {
             t1Select.innerHTML = '';
             Object.keys(gameState.players.team1 || {}).forEach(name => {
                 const opt = document.createElement('option');
                 opt.value = name; opt.textContent = name; t1Select.appendChild(opt);
             });
         }
         if (t2Select) {
             t2Select.innerHTML = '';
             Object.keys(gameState.players.team2 || {}).forEach(name => {
                 const opt = document.createElement('option');
                 opt.value = name; opt.textContent = name; t2Select.appendChild(opt);
             });
         }
     }








     function updateStatsDisplay() {
         const playerStatsDisplay = document.getElementById('player-stats-display');
         if (!playerStatsDisplay) return;








         const team1Label = gameState.teams.team1.id;
         const team2Label = gameState.teams.team2.id;








         let statsHtml = '';








         if (gameState.players.team1 && Object.keys(gameState.players.team1).length > 0) {
             statsHtml += '<h4>' + team1Label + ' Player Statistics</h4>';
             statsHtml += '<table class="player-stats-table">';
             statsHtml += '<thead><tr><th>Player</th><th>Serves</th><th>Aces</th><th>Blocks</th><th>Spikes</th><th>Points</th></tr></thead>';
             statsHtml += '<tbody>';
          
             Object.keys(gameState.players.team1).forEach(function(playerName) {
                 const player = gameState.players.team1[playerName];
                 statsHtml += '<tr>';
                 statsHtml += '<td class="player-name">' + playerName + '</td>';
                 statsHtml += '<td class="player-stat-value">' + (player.serves || 0) + '</td>';
                 statsHtml += '<td class="player-stat-value">' + (player.aces || 0) + '</td>';
                 statsHtml += '<td class="player-stat-value">' + (player.blocks || 0) + '</td>';
                 statsHtml += '<td class="player-stat-value">' + (player.spikes || 0) + '</td>';
                 statsHtml += '<td class="player-stat-value">' + (player.points || 0) + '</td>';
                 statsHtml += '</tr>';
             });
          
             statsHtml += '</tbody></table>';
         }








         if (gameState.players.team2 && Object.keys(gameState.players.team2).length > 0) {
             statsHtml += '<h4>' + team2Label + ' Player Statistics</h4>';
             statsHtml += '<table class="player-stats-table">';
             statsHtml += '<thead><tr><th>Player</th><th>Serves</th><th>Aces</th><th>Blocks</th><th>Spikes</th><th>Points</th></tr></thead>';
             statsHtml += '<tbody>';
          
             Object.keys(gameState.players.team2).forEach(function(playerName) {
                 const player = gameState.players.team2[playerName];
                 statsHtml += '<tr>';
                 statsHtml += '<td class="player-name">' + playerName + '</td>';
                 statsHtml += '<td class="player-stat-value">' + (player.serves || 0) + '</td>';
                 statsHtml += '<td class="player-stat-value">' + (player.aces || 0) + '</td>';
                 statsHtml += '<td class="player-stat-value">' + (player.blocks || 0) + '</td>';
                 statsHtml += '<td class="player-stat-value">' + (player.spikes || 0) + '</td>';
                 statsHtml += '<td class="player-stat-value">' + (player.points || 0) + '</td>';
                 statsHtml += '</tr>';
             });
          
             statsHtml += '</tbody></table>';
         }








         if (statsHtml === '') {
             statsHtml = '<p>No player statistics available. Start a match and record stats to see player data here.</p>';
         }








         playerStatsDisplay.innerHTML = statsHtml;
     }








     function downloadStatsToCSV() {
         if (!gameState.isActive) {
             alert('No active game to download.');
             return;
         }








         function escapeCSV(value) {
             if (value === null || value === undefined) return '';
             const stringValue = String(value);
             if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                 return '"' + stringValue.replace(/"/g, '""') + '"';
             }
             return stringValue;
         }








         const team1Label = gameState.teams.team1.id;
         const team2Label = gameState.teams.team2.id;








         let csv = '';








         if (gameState.players.team1 && Object.keys(gameState.players.team1).length > 0) {
             csv += `${escapeCSV(team1Label)} Player Statistics\n`;
             csv += 'Player,Serves,Aces,Blocks,Spikes,Points\n';
          
             Object.keys(gameState.players.team1).forEach(function(playerName) {
                 const player = gameState.players.team1[playerName];
                 csv += `${escapeCSV(playerName)},${player.serves || 0},${player.aces || 0},${player.blocks || 0},${player.spikes || 0},${player.points || 0}\n`;
             });
          
             csv += '\n';
         }








         if (gameState.players.team2 && Object.keys(gameState.players.team2).length > 0) {
             csv += `${escapeCSV(team2Label)} Player Statistics\n`;
             csv += 'Player,Serves,Aces,Blocks,Spikes,Points\n';
          
             Object.keys(gameState.players.team2).forEach(function(playerName) {
                 const player = gameState.players.team2[playerName];
                 csv += `${escapeCSV(playerName)},${player.serves || 0},${player.aces || 0},${player.blocks || 0},${player.spikes || 0},${player.points || 0}\n`;
             });
         }








         const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
         const link = document.createElement('a');
         const url = URL.createObjectURL(blob);
      
         link.setAttribute('href', url);
         link.setAttribute('download', `game_stats_${team1Label}_vs_${team2Label}.csv`);
         link.style.visibility = 'hidden';
      
         document.body.appendChild(link);
         link.click();
         document.body.removeChild(link);
     }








     // Save current set data to history
     function saveCurrentSetToHistory() {
         const setData = {
             setNumber: gameState.setNumber,
             team1Score: gameState.teams.team1.score,
             team2Score: gameState.teams.team2.score,
             winner: gameState.teams.team1.score > gameState.teams.team2.score ? 'team1' : 'team2',
             team1Players: JSON.parse(JSON.stringify(gameState.players.team1)),
             team2Players: JSON.parse(JSON.stringify(gameState.players.team2))
         };
         gameState.setHistory.push(setData);
       
         // Update sets won
         if (setData.winner === 'team1') {
             gameState.teams.team1.setsWon++;
         } else {
             gameState.teams.team2.setsWon++;
         }
     }




     // Reset player stats for new set
     function resetPlayerStatsForNewSet() {
         if (gameState.playerNames) {
             gameState.playerNames.team1.forEach(name => {
                 gameState.players.team1[name] = { serves: 0, aces: 0, blocks: 0, spikes: 0, points: 0 };
             });
             gameState.playerNames.team2.forEach(name => {
                 gameState.players.team2[name] = { serves: 0, aces: 0, blocks: 0, spikes: 0, points: 0 };
             });
         }
         gameState.teams.team1.score = 0;
         gameState.teams.team2.score = 0;
         initializeStats();
     }




     function nextSet() {
         // Save current set data
         saveCurrentSetToHistory();
       
         // Check if match is won (first to 2 sets)
         if (gameState.teams.team1.setsWon >= 2) {
             alert(`${gameState.teams.team1.id} wins the match 2-${gameState.teams.team2.setsWon}!`);
             endGame();
             return;
         }
         if (gameState.teams.team2.setsWon >= 2) {
             alert(`${gameState.teams.team2.id} wins the match 2-${gameState.teams.team1.setsWon}!`);
             endGame();
             return;
         }
       
         // If tied 1-1, start set 3
         if (gameState.setNumber < gameState.maxSets) {
             gameState.setNumber++;
             resetPlayerStatsForNewSet();
             updateGameDisplay();
             syncToFirebase();
             alert(`Set ${gameState.setNumber} starting!`);
         }
     }




     // Generate CSV for all sets
     function generateMatchCSV() {
         function escapeCSV(value) {
             if (value === null || value === undefined) return '';
             const stringValue = String(value);
             if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                 return '"' + stringValue.replace(/"/g, '""') + '"';
             }
             return stringValue;
         }




         const team1Label = gameState.teams.team1.id;
         const team2Label = gameState.teams.team2.id;
         let csv = '';




         // Match header
         csv += `Match: ${team1Label} vs ${team2Label}\n`;
         csv += `Final Result: ${team1Label} ${gameState.teams.team1.setsWon} - ${gameState.teams.team2.setsWon} ${team2Label}\n`;
         csv += `Match Winner: ${gameState.teams.team1.setsWon > gameState.teams.team2.setsWon ? team1Label : team2Label}\n\n`;




         // Generate table for each set
         gameState.setHistory.forEach((setData, index) => {
             csv += `=== SET ${setData.setNumber} ===\n`;
             csv += `Score: ${team1Label} ${setData.team1Score} - ${setData.team2Score} ${team2Label}\n`;
             csv += `Set Winner: ${setData.winner === 'team1' ? team1Label : team2Label}\n\n`;




             // Team 1 players for this set
             csv += `${team1Label} Player Statistics (Set ${setData.setNumber})\n`;
             csv += 'Player,Serves,Aces,Blocks,Spikes,Points\n';
             Object.keys(setData.team1Players).forEach(playerName => {
                 const player = setData.team1Players[playerName];
                 csv += `${escapeCSV(playerName)},${player.serves || 0},${player.aces || 0},${player.blocks || 0},${player.spikes || 0},${player.points || 0}\n`;
             });
             csv += '\n';




             // Team 2 players for this set
             csv += `${team2Label} Player Statistics (Set ${setData.setNumber})\n`;
             csv += 'Player,Serves,Aces,Blocks,Spikes,Points\n';
             Object.keys(setData.team2Players).forEach(playerName => {
                 const player = setData.team2Players[playerName];
                 csv += `${escapeCSV(playerName)},${player.serves || 0},${player.aces || 0},${player.blocks || 0},${player.spikes || 0},${player.points || 0}\n`;
             });
             csv += '\n';
         });




         return csv;
     }




     function endGame() {
         if (confirm('Are you sure you want to end this match?')) {
             // Save current set if not already saved (in case game ends mid-set)
             if (gameState.setHistory.length < gameState.setNumber) {
                 saveCurrentSetToHistory();
             }




             // Generate and download CSV
             const csv = generateMatchCSV();
             const team1Label = gameState.teams.team1.id;
             const team2Label = gameState.teams.team2.id;
           
             const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
             const link = document.createElement('a');
             const url = URL.createObjectURL(blob);
             link.setAttribute('href', url);
             link.setAttribute('download', `match_${team1Label}_vs_${team2Label}_${new Date().toISOString().slice(0,10)}.csv`);
             link.style.visibility = 'hidden';
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);




             gameState.isActive = false;
             document.getElementById('game-panel').classList.add('hidden');




             const finalGameState = { ...gameState, endTime: serverTimestamp() };
             addDoc(collection(db, 'gameHistory'), finalGameState)
                 .then(() => console.log('Final game state saved to history.'))
                 .catch(error => console.error('Error saving game history:', error));




             // Reset game state
             gameState.teams.team1.score = 0;
             gameState.teams.team2.score = 0;
             gameState.teams.team1.setsWon = 0;
             gameState.teams.team2.setsWon = 0;
             gameState.setNumber = 1;
             gameState.setHistory = [];
             initializeStats();
             gameState.players = { team1: {}, team2: {} };
             updateGameDisplay();
             syncToFirebase();




             alert('Match ended successfully! CSV downloaded and results saved to history.');
         }
     }








     window.startGame = startGame;
     window.nextSet = nextSet;
     window.endGame = endGame;
     window.downloadStatsToCSV = downloadStatsToCSV;








     // Load initial game state from Firebase on page load
     async function loadInitialGameState() {
         try {
             const snapshot = await get(realtimeGameRef);
             if (snapshot.exists()) {
                 const remoteState = snapshot.val();
                 console.log('Loading initial game state from database:', remoteState);
                
                 if (!isLocalRealtimeSync && remoteState) {
                     gameState = JSON.parse(JSON.stringify(remoteState));
                    
                     // Ensure nested objects exist
                     if (!gameState.teams) {
                         gameState.teams = {
                             team1: { id: '', score: 0, setsWon: 0 },
                             team2: { id: '', score: 0, setsWon: 0 }
                         };
                     }
                     if (!gameState.stats) {
                         gameState.stats = {
                             team1: { serves: 0, aces: 0, blocks: 0, spikes: 0 },
                             team2: { serves: 0, aces: 0, blocks: 0, spikes: 0 }
                         };
                     }
                     if (!gameState.players) {
                         gameState.players = { team1: {}, team2: {} };
                     }
                     if (!gameState.setHistory) {
                         gameState.setHistory = [];
                     }
                    
                     // Update UI with loaded state
                     if (gameState.isActive) {
                         document.getElementById('game-panel')?.classList.remove('hidden');
                         createScoringButtons();
                     }
                     updateGameDisplay();
                    
                     console.log('✓ Initial game state loaded from Firebase');
                 }
             } else {
                 console.log('No existing game state found in database');
             }
         } catch (error) {
             console.error('Error loading initial game state:', error);
         }
     }


     document.addEventListener('DOMContentLoaded', function() {
         console.log('Page loaded, initializing Firebase connection...');
        
         // Load initial state first
         loadInitialGameState();
        
         // Subscribe to real-time updates from Firebase
         subscribeToRealtimeGame();
         console.log('Firebase Realtime Database subscription active. Listening to /currentGame');
        
         // Initialize buttons immediately so they're ready when page loads
         createScoringButtons();
        
         // Periodically verify connection (as backup, though real-time should handle it)
         setInterval(() => {
             if (gameState.isActive) {
                 // Verify connection status
                 const connectedRef = ref(realtimeDB, '.info/connected');
                 get(connectedRef).then((snapshot) => {
                     if (snapshot.val() === false) {
                         console.warn('Connection lost, attempting to reconnect...');
                     }
                 }).catch(err => {
                     console.error('Connection check error:', err);
                 });
             }
         }, 30000); // Check every 30 seconds
        
         console.log('✓ Firebase Realtime Database sync initialized and active');
     });
 </script>
</head>
<body>
 <div class="container">
     <h1>Sports Statistics Tracker - Admin Interface</h1>








     <div class="card">
         <h2>Match Setup</h2>
         <div class="match-setup">
             <div class="team-setup">
                 <h3>Team 1</h3>
                 <div class="form-group">
                     <label>Select Team:</label>
                     <select id="team1-identifier">
                         <option value="">Select Class</option>
                         <option value="1A">1A</option>
                         <option value="1B">1B</option>
                         <option value="1C">1C</option>
                         <option value="1D">1D</option>
                         <option value="2A">2A</option>
                         <option value="2B">2B</option>
                         <option value="2C">2C</option>
                         <option value="2D">2D</option>
                         <option value="3A">3A</option>
                         <option value="3B">3B</option>
                         <option value="3C">3C</option>
                         <option value="3D">3D</option>
                         <option value="4A">4A</option>
                         <option value="4B">4B</option>
                         <option value="4C">4C</option>
                         <option value="4D">4D</option>
                         <option value="5A">5A</option>
                         <option value="5B">5B</option>
                         <option value="5C">5C</option>
                         <option value="5D">5D</option>
                         <option value="6A">6A</option>
                         <option value="6B">6B</option>
                         <option value="6C">6C</option>
                         <option value="6D">6D</option>
                         <option value="7A">7A</option>
                         <option value="7B">7B</option>
                         <option value="7C">7C</option>
                         <option value="7D">7D</option>
                         <option value="8A">8A</option>
                         <option value="8B">8B</option>
                         <option value="8C">8C</option>
                         <option value="8D">8D</option>
                         <option value="9A">9A</option>
                         <option value="9B">9B</option>
                         <option value="9C">9C</option>
                         <option value="9D">9D</option>
                         <option value="10A">10A</option>
                         <option value="10B">10B</option>
                         <option value="10C">10C</option>
                         <option value="10D">10D</option>
                         <!-- Grades 11-12 (A, IB1, IB2, IB3) -->
                         <option value="11A">11A</option>
                         <option value="11B">11B</option>
                         <option value="11C">11C</option>
                         <option value="11D">11D</option>
                         <option value="12A">12A</option>
                         <option value="12IB1">12IB1</option>
                         <option value="12IB2">12IB2</option>
                         <option value="12IB3">12IB3</option>
                     </select>
                 </div>
                 <div class="form-group">
                     <label>Players (comma-separated):</label>
                     <textarea id="team1-players" rows="2" placeholder="e.g., Alice, Bob, Carol"></textarea>
                 </div>
             </div>








             <div class="team-setup">
                 <h3>Team 2</h3>
                 <div class="form-group">
                     <label>Select Team:</label>
                     <select id="team2-identifier">
                         <option value="">Select Class</option>
                         <option value="1A">1A</option>
                         <option value="1B">1B</option>
                         <option value="1C">1C</option>
                         <option value="1D">1D</option>
                         <option value="2A">2A</option>
                         <option value="2B">2B</option>
                         <option value="2C">2C</option>
                         <option value="2D">2D</option>
                         <option value="3A">3A</option>
                         <option value="3B">3B</option>
                         <option value="3C">3C</option>
                         <option value="3D">3D</option>
                         <option value="4A">4A</option>
                         <option value="4B">4B</option>
                         <option value="4C">4C</option>
                         <option value="4D">4D</option>
                         <option value="5A">5A</option>
                         <option value="5B">5B</option>
                         <option value="5C">5C</option>
                         <option value="5D">5D</option>
                         <option value="6A">6A</option>
                         <option value="6B">6B</option>
                         <option value="6C">6C</option>
                         <option value="6D">6D</option>
                         <option value="7A">7A</option>
                         <option value="7B">7B</option>
                         <option value="7C">7C</option>
                         <option value="7D">7D</option>
                         <option value="8A">8A</option>
                         <option value="8B">8B</option>
                         <option value="8C">8C</option>
                         <option value="8D">8D</option>
                         <option value="9A">9A</option>
                         <option value="9B">9B</option>
                         <option value="9C">9C</option>
                         <option value="9D">9D</option>
                         <option value="10A">10A</option>
                         <option value="10B">10B</option>
                         <option value="10C">10C</option>
                         <option value="10D">10D</option>
                         <!-- Grades 11-12 (A, IB1, IB2, IB3) -->
                         <option value="11A">11A</option>
                         <option value="11B">11B</option>
                         <option value="11C">11C</option>
                         <option value="11D">11D</option>
                         <option value="12A">12A</option>
                         <option value="12IB1">12IB1</option>
                         <option value="12IB2">12IB2</option>
                         <option value="12IB3">12IB3</option>
                     </select>
                 </div>
                 <div class="form-group">
                     <label>Players (comma-separated):</label>
                     <textarea id="team2-players" rows="2" placeholder="e.g., Dave, Emma, Frank"></textarea>
                 </div>
             </div>








             <div class="controls-section">
                 <h3>Game Settings</h3>
                 <div class="form-group">
                     <button class="btn btn-primary" onclick="startGame()">Start Match</button>
                 </div>
             </div>
         </div>
     </div>








     <div id="game-panel" class="hidden">
         <div class="card">
             <h2>Live Game Control</h2>
             <div class="game-controls">
                 <button class="btn btn-secondary" onclick="nextSet()">Next Set</button>
                 <button class="btn btn-danger" onclick="endGame()">End Match</button>
             </div>








             <div class="score-display">
                 <div class="team-score">
                     <div class="team-label" id="display-team1">Team 1</div>
                     <div class="score" id="score1">0</div>
                 </div>
                 <div class="period-info">
                     <div id="period-display">Set 1</div>
                 </div>
                 <div class="team-score">
                     <div class="team-label" id="display-team2">Team 2</div>
                     <div class="score" id="score2">0</div>
                 </div>
             </div>








             <div class="scoring-panel">
                 <div class="team-controls">
                     <h4 id="team1-control-title">Team 1</h4>
                     <div class="form-group">
                         <label>Player:</label>
                         <select id="team1-player-select"></select>
                     </div>
                     <div id="team1-buttons"></div>
                 </div>
                 <div class="team-controls">
                     <h4 id="team2-control-title">Team 2</h4>
                     <div class="form-group">
                         <label>Player:</label>
                         <select id="team2-player-select"></select>
                     </div>
                     <div id="team2-buttons"></div>
                 </div>
             </div>
             <div class="card">
                 <div style="display: flex; justify-content: space-between; align-items: center;">
                     <h3>Player Statistics</h3>
                     <button class="btn btn-secondary" onclick="downloadStatsToCSV()" style="margin-left: 10px;">Download CSV</button>
                 </div>
                 <div class="player-stats-container" id="player-stats-display"></div>
             </div>
         </div>
     </div>
 </div>
</body>
</html>











